<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>24e Regiment d'Infanterie - 1914-1918</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: Georgia, serif; background: #f5f0e6; }
        #container { display: flex; height: 100vh; }
        #map { width: 66.666%; height: 100%; background: #fff; }
        #panel {
            width: 33.333%;
            display: flex;
            flex-direction: column;
            background: #fff;
            border-left: 1px solid #d0c8b8;
        }
        #header {
            padding: 15px 20px;
            background: #2c2416;
            color: #d4c9b0;
            font-size: 14px;
        }
        #header h1 { font-size: 16px; font-weight: normal; margin-bottom: 4px; }
        #header .date { font-size: 12px; color: #a09080; }
        #text-container {
            flex: 1;
            overflow-y: auto;
            padding: 20px;
            line-height: 1.8;
            font-size: 15px;
            color: #2c2416;
        }
        .paragraph { margin-bottom: 1.5em; }
        .place-name {
            background: rgba(139, 0, 0, 0.5);
            padding: 1px 4px;
            border-radius: 2px;
        }
        .date-name {
            background: rgba(0, 100, 200, 0.5);
            padding: 1px 4px;
            border-radius: 2px;
        }
        #nav {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 20px;
            background: #f8f5ef;
            border-top: 1px solid #d0c8b8;
        }
        .nav-btn {
            background: #2c2416;
            border: none;
            color: #d4c9b0;
            padding: 10px 20px;
            cursor: pointer;
            font-family: Georgia, serif;
            font-size: 14px;
        }
        .nav-btn:hover { background: #3c3426; }
        .nav-btn:disabled { opacity: 0.3; cursor: default; }
        #progress { font-size: 12px; color: #8b7355; }
        .leaflet-tooltip {
            background: rgba(44,36,22,0.9);
            border: none;
            color: #f5f0e6;
            font-family: Georgia, serif;
            padding: 4px 8px;
        }
        .leaflet-tooltip-top:before { border-top-color: rgba(44,36,22,0.9); }
    </style>
</head>
<body>
    <div id="container">
        <div id="map"></div>
        <div id="panel">
            <div id="header">
                <h1 id="chapter-title">-</h1>
                <div class="date" id="current-date">-</div>
            </div>
            <div id="text-container"></div>
            <div id="nav">
                <button class="nav-btn" id="prev-btn">&larr; Precedent</button>
                <span id="progress">-</span>
                <button class="nav-btn" id="next-btn">Suivant &rarr;</button>
            </div>
        </div>
    </div>
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script>
        const chunks = {{ chunks_json | safe }};
        const allPlaces = {{ all_places_json | safe }};
        let currentIndex = 0;
        let map;
        let activeMarkers = [];
        let inactiveMarkers = [];

        function initMap() {
            map = L.map('map', { zoomControl: false }).setView([48.8, 2.5], 6);

            // IGN Carte Etat-Major (WMTS)
            L.tileLayer('https://data.geopf.fr/wmts?' +
                'SERVICE=WMTS&REQUEST=GetTile&VERSION=1.0.0' +
                '&LAYER=GEOGRAPHICALGRIDSYSTEMS.ETATMAJOR40' +
                '&STYLE=normal' +
                '&FORMAT=image/jpeg' +
                '&TILEMATRIXSET=PM' +
                '&TILEMATRIX={z}&TILEROW={y}&TILECOL={x}', {
                maxZoom: 16,
                attribution: 'IGN'
            }).addTo(map);

            // Add all places as inactive markers initially
            addAllInactiveMarkers();

            showChunk(0);
        }

        function addAllInactiveMarkers() {
            allPlaces.forEach(p => {
                const marker = L.circleMarker([p.latitude, p.longitude], {
                    radius: 6,
                    fillColor: '#888',
                    color: '#fff',
                    weight: 1,
                    fillOpacity: 0.5,
                    opacity: 0.5
                }).addTo(map);
                marker.placeKey = `${p.latitude},${p.longitude}`;
                inactiveMarkers.push(marker);
            });
        }

        function clearActiveMarkers() {
            activeMarkers.forEach(m => map.removeLayer(m));
            activeMarkers = [];
        }

        function showChunk(index) {
            if (index < 0 || index >= chunks.length) return;
            currentIndex = index;

            const chunk = chunks[index];
            document.getElementById('progress').textContent = `${index + 1} / ${chunks.length}`;
            document.getElementById('prev-btn').disabled = index === 0;
            document.getElementById('next-btn').disabled = index === chunks.length - 1;

            // Update header
            document.getElementById('chapter-title').textContent =
                `Chapitre ${chunk.chapter_number}: ${chunk.chapter_title}`;
            document.getElementById('current-date').textContent = chunk.date || '';

            // Render chunk text with highlighted places and dates
            renderText(chunk);

            // Update map
            updateMap(chunk);
        }

        function renderText(chunk) {
            const container = document.getElementById('text-container');
            let html = chunk.text || '';

            // Replace {{date}} with highlighted span (remove markers)
            html = html.replace(/\{\{([^}]+)\}\}/g, '<span class="date-name">$1</span>');

            // Replace [[place]] with highlighted span (remove markers)
            html = html.replace(/\[\[([^\]]+)\]\]/g, '<span class="place-name">$1</span>');

            // Replace French quotes with italic text
            html = html.replace(/«\s*([\s\S]*?)\s*»/g, '« <em>$1</em> »');

            // Replace newlines with <br> for line breaks
            html = html.replace(/\n/g, '<br>');

            container.innerHTML = `<div class="paragraph">${html}</div>`;
            container.scrollTop = 0;
        }

        function updateMap(chunk) {
            clearActiveMarkers();

            // Get current chunk's place coordinates
            const chunkPlaceKeys = new Set();
            const places = (chunk.places || []).filter(p => p.geocoded);
            places.forEach(p => {
                chunkPlaceKeys.add(`${p.geocoded.latitude},${p.geocoded.longitude}`);
            });

            // Update inactive markers opacity
            inactiveMarkers.forEach(m => {
                if (chunkPlaceKeys.has(m.placeKey)) {
                    m.setStyle({ fillOpacity: 0, opacity: 0 }); // Hide, will be replaced by active
                } else {
                    m.setStyle({ fillOpacity: 0.5, opacity: 0.5 }); // Show as inactive
                }
            });

            if (places.length === 0) return;

            const bounds = [];

            // Add active markers for current chunk's places
            places.forEach(p => {
                const lat = p.geocoded.latitude;
                const lon = p.geocoded.longitude;
                const name = p.display_name || p.text;
                bounds.push([lat, lon]);

                const marker = L.circleMarker([lat, lon], {
                    radius: 8,
                    fillColor: '#8b0000',
                    color: '#fff',
                    weight: 2,
                    fillOpacity: 0.9
                }).addTo(map);

                marker.bindTooltip(name, { permanent: true, direction: 'top', offset: [0, -8] });
                activeMarkers.push(marker);
            });

            // Fit bounds to active places (2-step animation)
            let targetZoom, targetCenter;
            if (bounds.length === 1) {
                targetZoom = 11;
                targetCenter = bounds[0];
            } else {
                const boundsObj = L.latLngBounds(bounds);
                targetCenter = boundsObj.getCenter();
                targetZoom = Math.min(12, map.getBoundsZoom(boundsObj, false, [60, 60]));
            }

            const currentZoom = map.getZoom();

            if (targetZoom < currentZoom) {
                // Zooming out: first dezoom, then move
                map.setZoom(targetZoom, { animate: true, duration: 4 });
                setTimeout(() => {
                    map.panTo(targetCenter, { animate: true, duration: 2 });
                }, 2000);
            } else {
                // Zooming in: first move, then zoom
                map.panTo(targetCenter, { animate: true, duration: 2 });
                setTimeout(() => {
                    map.setZoom(targetZoom, { animate: true, duration: 4 });
                }, 2000);
            }
        }

        function next() {
            if (currentIndex < chunks.length - 1) {
                showChunk(currentIndex + 1);
            }
        }

        function prev() {
            if (currentIndex > 0) {
                showChunk(currentIndex - 1);
            }
        }

        // Event listeners
        document.getElementById('prev-btn').onclick = prev;
        document.getElementById('next-btn').onclick = next;

        document.addEventListener('keydown', (e) => {
            if (e.key === 'ArrowLeft' || e.key === 'ArrowUp') { e.preventDefault(); prev(); }
            if (e.key === 'ArrowRight' || e.key === 'ArrowDown' || e.key === ' ') { e.preventDefault(); next(); }
        });

        let wheelTimeout = null;
        document.addEventListener('wheel', (e) => {
            if (e.ctrlKey || e.metaKey) return;
            if (e.target.closest('#text-container')) return; // Allow scroll in text
            e.preventDefault();
            if (wheelTimeout) return;
            wheelTimeout = setTimeout(() => { wheelTimeout = null; }, 300);
            if (e.deltaY > 0) next(); else prev();
        }, { passive: false });

        document.addEventListener('DOMContentLoaded', initMap);
    </script>
</body>
</html>
