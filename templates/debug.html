<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Debug - Verification NER</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: system-ui, sans-serif; background: #fff; color: #222; }
        #container { display: flex; height: 100vh; }
        #map { width: 40%; }
        #text-pane { width: 30%; display: flex; flex-direction: column; border-left: 1px solid #ccc; }
        #sidebar { width: 30%; display: flex; flex-direction: column; border-left: 1px solid #ccc; }

        /* Text pane */
        #text-header { padding: 8px 10px; background: #f5f5f5; border-bottom: 1px solid #ddd; font-size: 12px; font-weight: bold; }
        #text-content { flex: 1; overflow-y: auto; padding: 10px; font-size: 13px; line-height: 1.6; }
        #text-content .sentence-row { margin-bottom: 6px; display: flex; }
        #text-content .sent-num { min-width: 30px; color: #999; font-size: 11px; text-align: right; margin-right: 8px; user-select: none; flex-shrink: 0; }
        #text-content .ner-loc { background: rgba(139, 0, 0, 0.5); border-radius: 2px; padding: 0 2px; cursor: pointer; }
        #text-content .ner-loc:hover { background: rgba(139, 0, 0, 0.7); }
        #text-content .ner-date { background: rgba(0, 100, 200, 0.5); border-radius: 2px; padding: 0 2px; cursor: pointer; }
        #text-content .ner-date:hover { background: rgba(0, 100, 200, 0.7); }
        #text-content .ner-current { outline: 2px solid #c44; }

        /* Add tag section */
        #add-tag { padding: 10px; background: #f9f9f9; border-top: 1px solid #ddd; }
        #add-tag h4 { font-size: 11px; margin-bottom: 6px; color: #666; }
        #add-tag-form { display: flex; gap: 4px; flex-wrap: wrap; }
        #add-tag-form input { padding: 4px 6px; border: 1px solid #ccc; border-radius: 3px; font-size: 11px; }
        #add-tag-form input[name="word"] { flex: 1; min-width: 80px; }
        #add-tag-form input[name="line"] { width: 50px; }
        #add-tag-form select { padding: 4px; border: 1px solid #ccc; border-radius: 3px; font-size: 11px; }
        #add-tag-form button { padding: 4px 10px; background: #4a8a6a; color: #fff; border: none; border-radius: 3px; cursor: pointer; font-size: 11px; }
        #add-tag-form button:hover { background: #3a7a5a; }

        /* Sidebar */
        #sidebar-header { padding: 8px 10px; background: #f5f5f5; border-bottom: 1px solid #ddd; font-size: 12px; font-weight: bold; display: flex; justify-content: space-between; align-items: center; }
        #sidebar-header select { font-size: 11px; padding: 4px; }
        #content { flex: 1; overflow-y: auto; padding: 8px; }
        .entity { background: #fff; border: 1px solid #ddd; border-radius: 4px; padding: 10px; margin-bottom: 8px; }
        .entity.current { background: #f0f8f0; border-color: #4a8a6a; }
        .entity.added { background: #fff8f0; border-color: #c84; }
        .entity-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 4px; }
        .entity-type { font-size: 9px; text-transform: uppercase; padding: 2px 5px; border-radius: 2px; font-weight: bold; }
        .entity-type.loc { background: #e0f0ff; color: #369; }
        .entity-type.date { background: #fff0e0; color: #963; }
        .entity-id { font-size: 9px; color: #999; font-family: monospace; }
        .entity-text { font-size: 15px; font-weight: bold; color: #000; margin-bottom: 4px; }
        .entity-sentence { font-size: 11px; color: #555; line-height: 1.4; margin-bottom: 8px; max-height: 60px; overflow: hidden; }
        .entity-sentence mark { background: #ffeb3b; color: #000; padding: 0 2px; border-radius: 2px; }
        .correction-section { display: flex; flex-direction: column; gap: 4px; }
        .correction-buttons { display: flex; gap: 4px; }
        .corr-btn { padding: 4px 10px; border: 1px solid #999; border-radius: 3px; cursor: pointer; font-size: 11px; background: #fff; }
        .corr-btn:hover { background: #f0f0f0; }
        .corr-btn.active { background: #4a8a6a; color: #fff; border-color: #4a8a6a; }
        .corr-btn.active-na { background: #c44; color: #fff; border-color: #c44; }
        .correction-fields { display: flex; gap: 4px; }
        .correction-field { flex: 1; }
        .correction-field label { font-size: 9px; color: #666; display: block; margin-bottom: 1px; }
        .correction-field input { width: 100%; border: 1px solid #ccc; padding: 4px 6px; border-radius: 3px; font-size: 11px; }
        .correction-field input:focus { border-color: #4a8a6a; outline: none; }
        .coords { font-size: 10px; color: #4a8a6a; margin-top: 4px; }
        .delete-btn { font-size: 10px; color: #c44; cursor: pointer; margin-left: 8px; }
        .delete-btn:hover { text-decoration: underline; }
        #toolbar { padding: 8px; background: #f5f5f5; border-top: 1px solid #ddd; display: flex; gap: 6px; flex-wrap: wrap; }
        .tool-btn { background: #fff; border: 1px solid #999; color: #333; padding: 5px 10px; cursor: pointer; border-radius: 3px; font-size: 10px; }
        .tool-btn:hover { background: #eee; }
        select { background: #fff; border: 1px solid #999; padding: 6px; border-radius: 4px; font-size: 12px; }
    </style>
</head>
<body>
    <div id="container">
        <div id="map"></div>
        <div id="text-pane">
            <div id="text-header">Texte source (cliquer sur un mot NER pour y aller)</div>
            <div id="text-content"></div>
            <div id="add-tag">
                <h4>Ajouter un tag</h4>
                <div id="add-tag-form">
                    <input type="text" name="line" placeholder="Phrase">
                    <input type="text" name="word" placeholder="Mot ou expression">
                    <select name="type">
                        <option value="loc">Lieu</option>
                        <option value="date">Date</option>
                    </select>
                    <button type="button" id="add-tag-btn">Ajouter</button>
                </div>
            </div>
        </div>
        <div id="sidebar">
            <div id="sidebar-header">
                <span>Entites NER</span>
                <select id="filter">
                    <option value="all">Tous</option>
                    <option value="loc">Lieux</option>
                    <option value="date">Dates</option>
                </select>
            </div>
            <div id="content"></div>
            <div id="toolbar">
                <button class="tool-btn" id="export-places">Export lieux</button>
                <button class="tool-btn" id="export-dates">Export dates</button>
                <button class="tool-btn" id="export-added">Export ajouts</button>
            </div>
        </div>
    </div>
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script>
        const data = {{ data_json | safe }};
        const chapters = data.chapters || [];
        const allPlaces = data.all_places || [];
        const allDates = data.all_dates || [];

        // Build full text with line numbers
        let fullText = '';
        let lineNumber = 1;
        const lineMap = {}; // lineNumber -> {chapter, text}

        chapters.forEach(ch => {
            fullText += `\n=== Chapitre ${ch.number}: ${ch.title} ===\n\n`;
            lineNumber += 2;
            const lines = ch.text.split('\n');
            lines.forEach(line => {
                lineMap[lineNumber] = { chapter: ch.number, text: line };
                lineNumber++;
            });
            fullText += ch.text + '\n';
        });

        // Merge entities
        let allEntities = [
            ...allPlaces.map(p => ({...p, entityType: 'loc'})),
            ...allDates.map(d => ({...d, entityType: 'date'}))
        ].sort((a, b) => (a.global_order || 0) - (b.global_order || 0));

        // Load added entities from localStorage
        const addedEntities = JSON.parse(localStorage.getItem('addedEntities') || '[]');

        function getAllEntities() {
            return [...allEntities, ...addedEntities].sort((a, b) => (a.global_order || 0) - (b.global_order || 0));
        }

        let visibleEntities = [];
        let selectedEntityId = null;
        let map;
        let markers = [];

        const savedCorrections = JSON.parse(localStorage.getItem('corrections') || '{}');

        function initMap() {
            map = L.map('map').setView([48.5, 3.0], 6);
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                maxZoom: 18
            }).addTo(map);
            renderTextPane();
            updateVisibleEntities();
        }

        function splitIntoSentences(text) {
            // Split on sentence-ending punctuation followed by space or end
            const sentences = [];
            const regex = /[^.!?]*[.!?]+(?:\s|$)|[^.!?]+$/g;
            let match;
            while ((match = regex.exec(text)) !== null) {
                const s = match[0].trim();
                if (s) sentences.push(s);
            }
            return sentences;
        }

        function renderTextPane() {
            const container = document.getElementById('text-content');
            let html = '';
            let sentNum = 1;

            chapters.forEach(ch => {
                html += `<div class="sentence-row"><span class="sent-num"></span><strong>=== Chapitre ${ch.number}: ${ch.title} ===</strong></div>`;

                const sentences = splitIntoSentences(ch.text);
                sentences.forEach(sentence => {
                    let highlightedSentence = escapeHtml(sentence);

                    // Highlight NER entities in this sentence
                    const entitiesInChapter = [...ch.places || [], ...ch.dates || []];
                    entitiesInChapter.forEach(ent => {
                        const text = ent.text;
                        const escaped = escapeRegex(text);
                        const type = ent.label === 'LOC' ? 'loc' : 'date';
                        highlightedSentence = highlightedSentence.replace(
                            new RegExp(`(${escaped})`, 'g'),
                            `<span class="ner-${type}" data-id="${ent.id}">$1</span>`
                        );
                    });

                    // Also highlight added entities
                    addedEntities.filter(e => e.chapter === ch.number).forEach(ent => {
                        const escaped = escapeRegex(ent.text);
                        highlightedSentence = highlightedSentence.replace(
                            new RegExp(`(${escaped})`, 'g'),
                            `<span class="ner-${ent.entityType}" data-id="${ent.id}">$1</span>`
                        );
                    });

                    html += `<div class="sentence-row"><span class="sent-num">${sentNum}</span><span class="sent-text">${highlightedSentence}</span></div>`;
                    sentNum++;
                });
                html += '<div class="sentence-row">&nbsp;</div>';
            });

            container.innerHTML = html;

            // Add click handlers for NER spans
            container.querySelectorAll('[data-id]').forEach(span => {
                span.addEventListener('click', () => {
                    const id = span.dataset.id;
                    selectEntity(id);
                });
            });
        }

        function updateVisibleEntities() {
            const container = document.getElementById('text-content');
            const containerRect = container.getBoundingClientRect();
            const filter = document.getElementById('filter').value;

            // Find all NER spans currently visible in the text pane
            const visibleIds = new Set();
            container.querySelectorAll('[data-id]').forEach(span => {
                const rect = span.getBoundingClientRect();
                // Check if span is visible within container
                if (rect.top < containerRect.bottom && rect.bottom > containerRect.top) {
                    visibleIds.add(span.dataset.id);
                }
            });

            // Get entities for visible IDs
            const all = getAllEntities();
            visibleEntities = all.filter(e => {
                if (!visibleIds.has(e.id)) return false;
                if (filter === 'all') return true;
                return e.entityType === filter;
            });

            renderEntities();
            updateMap();
        }

        function selectEntity(id) {
            selectedEntityId = id;

            // Highlight in text pane
            document.querySelectorAll('#text-content .ner-current').forEach(el => el.classList.remove('ner-current'));
            const nerSpan = document.querySelector(`#text-content [data-id="${id}"]`);
            if (nerSpan) {
                nerSpan.classList.add('ner-current');
            }

            renderEntities();
            updateMap();
        }

        function escapeHtml(text) {
            return text.replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;');
        }

        function escapeRegex(text) {
            return text.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
        }

        function highlightText(sentence, text) {
            const escaped = text.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
            return sentence.replace(new RegExp(`(${escaped})`, 'gi'), '<mark>$1</mark>');
        }

        function getCorrection(id) {
            return savedCorrections[id] || { type: 'OK', coords: '', name: '' };
        }

        function saveCorrection(id, correction) {
            savedCorrections[id] = correction;
            localStorage.setItem('corrections', JSON.stringify(savedCorrections));
        }

        function getCorrectionValue(id) {
            const c = getCorrection(id);
            if (typeof c === 'string') {
                if (c === 'OK') return 'OK';
                if (c === 'N/A') return 'N/A';
                return c;
            }
            if (c.type === 'N/A') return 'N/A';
            if (c.coords) return c.coords;
            if (c.name) return c.name;
            return 'OK';
        }

        function renderEntities() {
            const content = document.getElementById('content');

            if (visibleEntities.length === 0) {
                content.innerHTML = '<p style="padding:20px;color:#666;">Aucune entite visible</p>';
                return;
            }

            content.innerHTML = visibleEntities.map(e => {
                const corr = getCorrection(e.id);
                const isOK = corr.type === 'OK' || corr === 'OK' || (!corr.type && !corr.coords && !corr.name);
                const isNA = corr.type === 'N/A' || corr === 'N/A';
                const coordsVal = typeof corr === 'object' ? (corr.coords || '') : '';
                const nameVal = typeof corr === 'object' ? (corr.name || '') : '';
                const isAdded = e.added;
                const isCurrent = e.id === selectedEntityId;

                return `
                <div class="entity ${isCurrent ? 'current' : ''} ${isAdded ? 'added' : ''}" data-entity-id="${e.id}">
                    <div class="entity-header">
                        <span class="entity-type ${e.entityType}">${e.entityType === 'loc' ? 'Lieu' : 'Date'}${isAdded ? ' (ajout√©)' : ''}</span>
                        <span class="entity-id">${e.id}${isAdded ? `<span class="delete-btn" data-id="${e.id}">suppr</span>` : ''}</span>
                    </div>
                    <div class="entity-text">${e.text}</div>
                    <div class="correction-section">
                        <div class="correction-buttons">
                            <button class="corr-btn ${isOK && !coordsVal && !nameVal ? 'active' : ''}" data-id="${e.id}" data-action="ok">OK</button>
                            <button class="corr-btn ${isNA ? 'active-na' : ''}" data-id="${e.id}" data-action="na">N/A</button>
                        </div>
                        <div class="correction-fields">
                            <div class="correction-field">
                                <label>Coordonnees</label>
                                <input type="text" data-id="${e.id}" data-field="coords" value="${coordsVal}" placeholder="48.85, 2.35">
                            </div>
                            <div class="correction-field">
                                <label>Nom alt.</label>
                                <input type="text" data-id="${e.id}" data-field="name" value="${nameVal}" placeholder="Verdun">
                            </div>
                        </div>
                    </div>
                    ${e.geocoded ? `<div class="coords">${e.geocoded.latitude.toFixed(4)}, ${e.geocoded.longitude.toFixed(4)}</div>` : ''}
                </div>
            `}).join('');

            // Entity click listeners (to select)
            content.querySelectorAll('.entity').forEach(div => {
                div.addEventListener('click', (ev) => {
                    if (ev.target.closest('.corr-btn') || ev.target.closest('input') || ev.target.closest('.delete-btn')) return;
                    const id = div.dataset.entityId;
                    selectEntity(id);
                });
            });

            // Button listeners
            content.querySelectorAll('.corr-btn').forEach(btn => {
                btn.addEventListener('click', (ev) => {
                    const id = ev.target.dataset.id;
                    const action = ev.target.dataset.action;
                    if (action === 'ok') {
                        saveCorrection(id, { type: 'OK', coords: '', name: '' });
                    } else if (action === 'na') {
                        saveCorrection(id, { type: 'N/A', coords: '', name: '' });
                    }
                    renderEntities();
                });
            });

            // Field listeners
            content.querySelectorAll('.correction-field input').forEach(input => {
                input.addEventListener('change', (ev) => {
                    const id = ev.target.dataset.id;
                    const field = ev.target.dataset.field;
                    const corr = getCorrection(id);
                    const newCorr = typeof corr === 'object' ? {...corr} : { type: 'OK', coords: '', name: '' };
                    newCorr[field] = ev.target.value;
                    if (ev.target.value) newCorr.type = '';
                    saveCorrection(id, newCorr);
                    renderEntities();
                });
            });

            // Delete listeners
            content.querySelectorAll('.delete-btn').forEach(btn => {
                btn.addEventListener('click', (ev) => {
                    ev.stopPropagation();
                    const id = ev.target.dataset.id;
                    deleteAddedEntity(id);
                });
            });
        }

        function updateMap() {
            // Clear existing markers
            markers.forEach(m => map.removeLayer(m));
            markers = [];

            // Add markers for all visible geocoded places
            const bounds = [];
            visibleEntities.filter(e => e.geocoded && e.entityType === 'loc').forEach(e => {
                const lat = e.geocoded.latitude;
                const lon = e.geocoded.longitude;
                const isCurrent = e.id === selectedEntityId;

                const marker = L.circleMarker([lat, lon], {
                    radius: isCurrent ? 12 : 8,
                    fillColor: isCurrent ? '#c44' : '#4a8a6a',
                    color: '#fff',
                    weight: isCurrent ? 3 : 2,
                    fillOpacity: 0.9
                }).addTo(map);

                marker.bindTooltip(e.text, { direction: 'top' });
                marker.on('click', () => selectEntity(e.id));
                markers.push(marker);
                bounds.push([lat, lon]);
            });

            // Fit bounds if we have markers
            if (bounds.length > 0) {
                if (bounds.length === 1) {
                    map.setView(bounds[0], 10);
                } else {
                    map.fitBounds(bounds, { padding: [40, 40], maxZoom: 12 });
                }
            }
        }

        function addEntity(line, word, type) {
            if (!word.trim()) return;

            const id = 'add_' + Date.now().toString(36);
            const chapter = Object.values(lineMap).find(l => l.text.includes(word))?.chapter || 'I';

            const entity = {
                id: id,
                text: word.trim(),
                entityType: type,
                label: type === 'loc' ? 'LOC' : 'DATE',
                sentence: word.trim(),
                chapter: chapter,
                global_order: 9999 + addedEntities.length,
                added: true
            };

            addedEntities.push(entity);
            localStorage.setItem('addedEntities', JSON.stringify(addedEntities));

            renderTextPane();
            updateVisibleEntities();

            // Select new entity
            selectEntity(id);
        }

        function deleteAddedEntity(id) {
            const idx = addedEntities.findIndex(e => e.id === id);
            if (idx >= 0) {
                addedEntities.splice(idx, 1);
                localStorage.setItem('addedEntities', JSON.stringify(addedEntities));
                if (selectedEntityId === id) selectedEntityId = null;
                renderTextPane();
                updateVisibleEntities();
            }
        }

        function exportYAML(type) {
            let entities;
            if (type === 'places') {
                entities = allPlaces;
            } else if (type === 'dates') {
                entities = allDates;
            } else {
                entities = addedEntities;
            }

            let yaml = '';
            entities.forEach(e => {
                const val = getCorrectionValue(e.id);
                yaml += `${e.id}:\n  original: "${e.text.replace(/"/g, '\\"')}"\n  correction: "${val}"\n`;
            });

            const blob = new Blob([yaml], {type: 'text/yaml'});
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = type === 'places' ? 'places_corrections.yaml' : (type === 'dates' ? 'dates_corrections.yaml' : 'added_entities.yaml');
            a.click();
            URL.revokeObjectURL(url);
        }

        // Event listeners
        document.getElementById('filter').onchange = updateVisibleEntities;
        document.getElementById('export-places').onclick = () => exportYAML('places');
        document.getElementById('export-dates').onclick = () => exportYAML('dates');
        document.getElementById('export-added').onclick = () => exportYAML('added');

        document.getElementById('add-tag-btn').onclick = () => {
            const line = document.querySelector('#add-tag-form input[name="line"]').value;
            const word = document.querySelector('#add-tag-form input[name="word"]').value;
            const type = document.querySelector('#add-tag-form select[name="type"]').value;
            addEntity(line, word, type);
            document.querySelector('#add-tag-form input[name="word"]').value = '';
        };

        // Update visible entities when scrolling the text pane
        let scrollTimeout = null;
        document.getElementById('text-content').addEventListener('scroll', () => {
            if (scrollTimeout) clearTimeout(scrollTimeout);
            scrollTimeout = setTimeout(updateVisibleEntities, 150);
        });

        document.addEventListener('DOMContentLoaded', initMap);
    </script>
</body>
</html>
